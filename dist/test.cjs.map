{"version":3,"file":"test.cjs","sources":["../src/utils.js","../src/mongo-adapter.js","../src/y-mongodb.js","../tests/y-mongodb.tests.js","../tests/index.js"],"sourcesContent":["import * as Y from 'yjs'\nimport * as binary from 'lib0/binary.js'\nimport * as encoding from 'lib0/encoding.js'\nimport { Buffer } from 'buffer'\n\nexport const PREFERRED_TRIM_SIZE = 400\n\n/**\n * @param {any} db\n * @param {string} docName\n * @param {number} from Greater than or equal\n * @param {number} to lower than (not equal)\n * @return {Promise<void>}\n */\nexport const clearUpdatesRange = async (db, docName, from, to) => db.del({\n  docName,\n  clock: {\n    $gte: from,\n    $lt: to\n  }\n})\n\n/**\n * @param {any} db\n * @param {string} docName\n * @param {Uint8Array} stateAsUpdate\n * @param {Uint8Array} stateVector\n * @return {Promise<number>} returns the clock of the flushed doc\n */\nexport const flushDocument = async (db, docName, stateAsUpdate, stateVector) => {\n  const clock = await storeUpdate(db, docName, stateAsUpdate)\n  await writeStateVector(db, docName, stateVector, clock)\n  await clearUpdatesRange(db, docName, 0, clock)\n  return clock\n}\n\n/**\n * Create a unique key for a update message.\n * @param {string} docName\n * @param {number} clock must be unique\n * @return {Object} [opts.version, opts.docName, opts.action, opts.clock]\n */\nexport const createDocumentUpdateKey = (docName, clock) => ({\n  version: 'v1',\n  action: 'update',\n  docName,\n  clock\n})\n\n/**\n * @param {string} docName\n * @return {Object} [opts.docName, opts.version]\n */\nexport const createDocumentStateVectorKey = docName => {\n  return {\n    docName: docName,\n    version: 'v1_sv'\n  }\n}\n\n/**\n * Level expects a Buffer, but in Yjs we typically work with Uint8Arrays.\n *\n * Since Level thinks that these are two entirely different things,\n * we transform the Uint8array to a Buffer before storing it.\n *\n * @param {any} db\n * @param {Object} values\n */\nexport const mongoPut = async (db, values) => await db.put(values)\n\n/**\n * @param {any} db\n * @param {object} query\n * @param {object} opts\n * @return {Promise<Array<any>>}\n */\nexport const getMongoBulkData = async (db, query, opts) => await db.readAsCursor(query, opts)\n\n/**\n * @param {any} db\n * @return {Promise<any>}\n */\nexport const flushDB = db => db.flush()\n\n/**\n * Get all document updates for a specific document.\n *\n * @param {any} db\n * @param {string} docName\n * @param {any} [opts]\n * @return {Promise<Array<Object>>}\n */\nexport const getMongoUpdates = async (db, docName, opts = {}) => await getMongoBulkData(db, {\n  ...createDocumentUpdateKey(docName, 0),\n  clock: {\n    $gte: 0,\n    $lt: binary.BITS32\n  }\n},\nopts\n)\n\n/**\n * @param {any} db\n * @param {string} docName\n * @return {Promise<number>} Returns -1 if this document doesn't exist yet\n */\nexport const getCurrentUpdateClock = async (db, docName) => await getMongoUpdates(db, docName, {\n  reverse: true,\n  limit: 1\n}).then(updates => {\n  if (updates.length === 0) {\n    return -1\n  } else {\n    return updates[0].clock\n  }\n})\n\n/**\n * @param {any} db\n * @param {string} docName\n * @param {Uint8Array} sv state vector\n * @param {number} clock current clock of the document so we can determine when this statevector was created\n */\nexport const writeStateVector = async (db, docName, sv, clock) => {\n  const encoder = encoding.createEncoder()\n  encoding.writeVarUint8Array(encoder, sv)\n  await mongoPut(db, {\n    ...createDocumentStateVectorKey(docName),\n    value: Buffer.from(encoding.toUint8Array(encoder)),\n    clock\n  })\n}\n\n/**\n * @param {any} db\n * @param {string} docName\n * @param {Uint8Array} update\n * @return {Promise<number>} Returns the clock of the stored update\n */\nexport const storeUpdate = async (db, docName, update) => {\n  const clock = await getCurrentUpdateClock(db, docName)\n  if (clock === -1) {\n    const ydoc = new Y.Doc()\n    Y.applyUpdate(ydoc, update)\n    const sv = Y.encodeStateVector(ydoc)\n    await writeStateVector(db, docName, sv, 0)\n  }\n\n  await mongoPut(db, {\n    ...createDocumentUpdateKey(docName, clock + 1),\n    value: Buffer.from(update)\n  })\n\n  return clock + 1\n}\n\n/**\n * @param {Array<Uint8Array>} updates\n * @return {{update:Uint8Array, sv: Uint8Array}}\n */\nexport const mergeUpdates = (updates) => {\n  const ydoc = new Y.Doc()\n  ydoc.transact(() => {\n    for (let i = 0; i < updates.length; i++) {\n      Y.applyUpdate(ydoc, updates[i])\n    }\n  })\n  return { update: Y.encodeStateAsUpdate(ydoc), sv: Y.encodeStateVector(ydoc) }\n}\n","const { MongoClient } = require('mongodb')\n\nexport class MongoAdapter {\n  constructor (location, dbName, collection) {\n    this.location = location\n    this.dbName = dbName\n    this.collection = collection || 'yjs-writings'\n    this.db = null\n    this.open()\n  }\n\n  open () {\n    const mongojsDb = new MongoClient(this.location, {useUnifiedTopology: true})\n\n    async function connect(){\n      try{\n        await mongojsDb.connect()\n\n        const db = mongojsDb.db(this.dbName)\n        this.db = db\n        console.log(\"=> Connected to Y-MongoDB\")\n      }finally{\n        await mongojsDb.close()\n      }\n    }\n\n    connect()\n  }\n\n  async get (query) {\n    return await this.db.collection(this.collection).findOne(query)\n  }\n\n  async put (values) {\n    if (!values.docName && !values.version && !values.value) { throw new Error('Document and version must be provided') }\n\n    return await this.db.collection(this.collection).save(values)\n  }\n\n  async del (query) {\n    const bulk = await this.db.collection(this.collection).initializeOrderedBulkOp()\n    await bulk.find(query).remove()\n    return await bulk.execute()\n  }\n\n  async readAsCursor (query, opts = {}) {\n    return await this.db.collection(this.collection).find(query).limit(opts.limit).sort({clock: -1}).toArray()\n  }\n\n  async close () {\n    return await this.db.close()\n  }\n\n  async flush () {\n    await this.db.dropDatabase()\n    await this.db.close()\n  }\n}\n","import * as Y from 'yjs'\nimport * as binary from 'lib0/binary.js'\nimport * as promise from 'lib0/promise.js'\n//\nimport { MongoAdapter } from './mongo-adapter'\nimport * as U from './utils'\n\nconst getUpdates = docs => {\n  if (!Array.isArray(docs) || !docs.length) return []\n\n  return docs.map(update => update.value.buffer)\n}\n\nexport class MongodbPersistence {\n  /**\n   * @param {string} location\n   * @param {string} [collection]\n   */\n  constructor (location, _db, collection) {\n    const db = new MongoAdapter(location, _db, collection)\n    this.tr = promise.resolve()\n\n    this._transact = f => {\n      const currTr = this.tr\n      this.tr = (async () => {\n        await currTr\n        let res = /** @type {any} */ (null)\n        try {\n          res = await f(db)\n        } catch (err) {\n          console.warn('Error during saving transaction', err)\n        }\n        return res\n      })()\n      return this.tr\n    }\n  }\n\n  /**\n   * @param {string} docName\n   * @return {Promise<Y.Doc>}\n   */\n  getYDoc (docName) {\n    return this._transact(async db => {\n      const docs = await U.getMongoUpdates(db, docName)\n      const updates = getUpdates(docs)\n      const ydoc = new Y.Doc()\n      ydoc.transact(() => {\n        for (let i = 0; i < updates.length; i++) {\n          Y.applyUpdate(ydoc, updates[i])\n        }\n      })\n      if (updates.length > U.PREFERRED_TRIM_SIZE) {\n        await U.flushDocument(db, docName, Y.encodeStateAsUpdate(ydoc), Y.encodeStateVector(ydoc))\n      }\n      return ydoc\n    })\n  }\n\n  /**\n   * @param {string} docName\n   * @param {Uint8Array} update\n   * @return {Promise<number>} Returns the clock of the stored update\n   */\n  storeUpdate (docName, update) {\n    return this._transact(db => U.storeUpdate(db, docName, update))\n  }\n\n  /**\n   * @param {string} docName\n   * @return {Promise<void>}\n   */\n  clearDocument (docName) {\n    return this._transact(async db => {\n      await db.del(U.createDocumentStateVectorKey(docName))\n      await U.clearUpdatesRange(db, docName, 0, binary.BITS32)\n    })\n  }\n\n  /**\n   * @param {string} docName\n   * @return {Promise<void>}\n   */\n  flushDocument (docName) {\n    return this._transact(async db => {\n      const docs = await U.getMongoUpdates(db, docName)\n      const updates = getUpdates(docs)\n      const { update, sv } = U.mergeUpdates(updates)\n      await U.flushDocument(db, docName, update, sv)\n    })\n  }\n\n  flushDB () {\n    return this._transact(async db => {\n      await U.flushDB(db)\n    })\n  }\n}\n","import * as Y from 'yjs'\nimport { PREFERRED_TRIM_SIZE, getMongoUpdates } from '../src/utils'\nimport { MongodbPersistence } from '../src/y-mongodb'\nimport * as t from 'lib0/testing.js'\n// import * as decoding from 'lib0/decoding.js'\n\nconst location = 'mongodb://localhost:27017/y-mongodb-test'\nconst collection = 'mongodb://localhost:27017/y-transactions'\n\nconst flushUpdatesHelper = (ldb, docName, actions) => {\n  return Promise.all(actions.map(action => ldb.storeUpdate(action.docName, action.update)))\n};\n\n\nexport const testMongodbUpdateStorage = async tc => {\n  const N = PREFERRED_TRIM_SIZE * 2\n\n  const docName = tc.testName\n  const ydoc1 = new Y.Doc()\n  ydoc1.clientID = 0\n  const dbPersistence = new MongodbPersistence(location, collection)\n  await dbPersistence.clearDocument(docName)\n\n  const updates = []\n\n  ydoc1.on('update', async update => {\n    updates.push({\n      docName,\n      update\n    })\n  });\n\n  await flushUpdatesHelper(dbPersistence, docName, updates)\n\n  const values = await dbPersistence._transact(db => getMongoUpdates(db, docName))\n  for (let i = 0; i < values.length; i++) {\n    t.assert(values[i].clock === i)\n  }\n\n  const yarray = ydoc1.getArray('arr')\n  for (let i = 0; i < N; i++) {\n    yarray.insert(0, [i])\n  }\n\n  await dbPersistence.flushDocument(docName)\n\n  const mergedUpdates = await dbPersistence._transact(db => getMongoUpdates(db, docName))\n  t.assert(mergedUpdates.length === 1)\n\n  await dbPersistence.flushDB();\n};\n","\nimport * as mongodb from './y-mongodb.tests.js'\n\nimport { runTests } from 'lib0/testing.js'\nimport { isNode } from 'lib0/environment.js'\n\nif (isNode) {\n  runTests({\n    mongodb\n  }).then(success => {\n    process.exit(success ? 0 : 1)\n  })\n\n}\n"],"names":["binary.BITS32","encoding.createEncoder","encoding.writeVarUint8Array","Buffer","encoding.toUint8Array","Y.Doc","Y.applyUpdate","Y.encodeStateVector","Y.encodeStateAsUpdate","promise.resolve","U.getMongoUpdates","U.PREFERRED_TRIM_SIZE","U.flushDocument","U.storeUpdate","U.createDocumentStateVectorKey","U.clearUpdatesRange","U.mergeUpdates","U.flushDB","t.assert","isNode","runTests"],"mappings":"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"}